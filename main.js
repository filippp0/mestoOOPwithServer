(()=>{"use strict";const e="images/load3.47bc84f53b5a5fd159e5.gif";class t{constructor(e,t,s,i,r){this._link=e.link,this._name=e.name,this._cardId=e._id,this._myId=e.myid,this._ownerId=e.owner._id,this._likes=e.likes,this._likesLength=e.likes.length,this._changeLike=r,this._openImagePopup=s,this._openDelete=i,this._cloneElement=document.querySelector(t).content.querySelector(".elements__list").cloneNode(!0),this._imageElement=this._cloneElement.querySelector(".elements__image"),this._likeIconElement=this._cloneElement.querySelector(".elements__like-icon"),this._trashElement=this._cloneElement.querySelector(".elements__trash"),this._subTitle=this._cloneElement.querySelector(".elements__subtitle"),this._counter=this._cloneElement.querySelector(".elements__counter")}_handleLike=()=>{this._changeLike(this._likeIconElement,this._cardId)};_handleDeleteElement=()=>{this._openDelete({cardId:this._cardId,card:this})};_handleOpenImageInPopupImage=()=>{this._openImagePopup({title:this._name,link:this._link})};_setEventListener(){this._likeIconElement.addEventListener("click",this._handleLike),this._trashElement.addEventListener("click",this._handleDeleteElement),this._imageElement.addEventListener("click",this._handleOpenImageInPopupImage)}_checkLikeStatus(){this._likes.forEach((e=>{e._id!==this._myId||this._likeIconElement.classList.add("elements__like-icon_active")})),this._counter.textContent=this._likesLength}_changeVisibleForTrashButton(){this._myId===this._ownerId?this._trashElement.style.display="block":this._trashElement.style.display="none"}removeCard(){this._cloneElement.remove(),this._cloneElement=null}toggelLike(e){this._likeIconElement.classList.toggle("elements__like-icon_active"),this._counter.textContent=e.length}createCard(){return this._imageElement.src=this._link,this._imageElement.alt=`Изображение ${this._name}`,this._subTitle.textContent=this._name,this._checkLikeStatus(),this._changeVisibleForTrashButton(),this._setEventListener(),this._cloneElement}}class s{constructor(e,t){this._inputSelector=e.inputSelector,this._submitButtonSelector=e.submitButtonSelector,this._errorSelectorTemplate=e.errorSelectorTemplate,this._disableButtonClass=e.disableButtonClass,this._inputErrorClass=e.inputErrorClass,this._form=t,this._button=t.querySelector(e.submitButtonSelector),this._inputList=t.querySelectorAll(e.inputSelector)}_showInputError(){this._input.classList.add(this._inputErrorClass),this._errorTextElement.textContent=this._input.validationMessage}_hideInputError(){this._input.classList.remove(this._inputErrorClass),this._errorTextElement.textContent=""}_enableButton(){this._button.classList.remove(this._disableButtonClass),this._button.disabled=!1}_disableButton(){this._button.classList.add(this._disableButtonClass),this._button.disabled=!0}_hasValidInput(){return Array.from(this._inputList).every((e=>e.validity.valid))}_toggleButtonState(){this._hasValidInput()?this._enableButton():this._disableButton()}_checkInputValidity(){this._errorTextElement=this._form.querySelector(`${this._errorSelectorTemplate}${this._input.name}`),this._input.validity.valid?this._hideInputError():this._showInputError()}_setEventListener(){this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._input=e,this._checkInputValidity(),this._toggleButtonState()}))}))}enableValidation(){this._setEventListener()}resetErrorForOpenForm(){this._inputList.forEach((e=>{this._input=e,this._errorTextElement=this._form.querySelector(`${this._errorSelectorTemplate}${e.name}`),e.validity.valid||this._hideInputError()})),this._disableButton()}}class i{constructor(e){this._popup=document.querySelector(e),this._popupCloseButton=this._popup.querySelector(".popup__close-icon")}_handleEscClose=e=>{"Escape"===e.key&&this.close()};_handleCloseButton=()=>{this.close()};_handleClickByOverlay=e=>{e.target===e.currentTarget&&this.close()};setEventListeners(){this._popup.addEventListener("mousedown",this._handleClickByOverlay),this._popupCloseButton.addEventListener("click",this._handleCloseButton)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}}class r extends i{constructor(e,t,s){super(e),this._load=t,this._submitFunction=s,this._form=this._popup.querySelector(".popup__form"),this._inputList=this._form.querySelectorAll(".popup__input"),this._submitButton=this._popup.querySelector(".popup__submit"),this._defaultButtonText=this._submitButton.textContent}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._submitFunction(this._getInputsValue())}))}_getInputsValue(){return this._values={},this._inputList.forEach((e=>{this._values[e.name]=e.value})),this._values}setInputsValue(e){this._inputList.forEach((t=>{t.value=e[t.name]}))}setupText(e,t){e?(this._submitButton.textContent="",this._submitButton.style.backgroundImage=`url(${this._load})`):(this._submitButton.style.backgroundImage="none",this._submitButton.textContent=this._defaultButtonText)}close(){super.close(),this._form.reset()}}const n=document.querySelector(".profile__edit"),o=document.querySelector(".profile__add-button"),a=document.querySelector(".profile__avatar-overlay"),l={},u={inputSelector:".popup__input",submitButtonSelector:".popup__submit",errorSelectorTemplate:".popup__error_type_",disableButtonClass:"popup__submit_disable",inputErrorClass:"popup__input_invalid"},h=new class{constructor(e){this._url=e.baseUrl,this._headers=e.headers,this._authorization=e.headers.authorization}_checkResponse(e){return e.ok?e.json():Promise.reject}_request(e,t){return fetch(`${this._url}${e}`,t).then(this._checkResponse)}getInfo(){return this._request("/users/me",{headers:{authorization:this._authorization}})}setUserInfo(e){return this._request("/users/me",{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e.username,about:e.job})})}getCards(){return this._request("/cards",{headers:{authorization:this._authorization}})}addCard(e){return this._request("/cards",{method:"POST",headers:this._headers,body:JSON.stringify({name:e.title,link:e.link})})}setNewAvatar(e){return this._request("/users/me/avatar",{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e.avatar})})}deleteCard(e){return this._request(`/cards/${e}`,{method:"DELETE",headers:{authorization:this._authorization}})}deleteLike(e){return this._request(`/cards/${e}/likes`,{method:"DELETE",headers:{authorization:this._authorization}})}addLike(e){return this._request(`/cards/${e}/likes`,{method:"PUT",headers:{authorization:this._authorization}})}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-66",headers:{authorization:"9f4d5ff3-f724-49c2-9657-4a12392beeb3","Content-Type":"application/json"}}),_=new class{constructor(e){this._profileName=document.querySelector(e.profileNameSelector),this._profileJob=document.querySelector(e.profileJobSelector),this.profileAvatar=document.querySelector(e.profileAvatarSelector)}getUserInfo(){return{username:this._profileName.textContent,job:this._profileJob.textContent}}setUserInfo({name:e,job:t,avatar:s}){this.profileAvatar.src=s,this._profileName.textContent=e,this._profileJob.textContent=t}}({profileNameSelector:".profile__name",profileJobSelector:".profile__job",profileAvatarSelector:".profile__avatar"}),c=new class extends i{constructor(e){super(e),this._popupImage=this._popup.querySelector(".image-popup__image"),this._imagePopupCaption=this._popup.querySelector(".image-popup__image-caption")}open=e=>{this._popupImage.src=e.link,this._popupImage.alt=`Изображение ${e.title}`,this._imagePopupCaption.textContent=e.title,super.open()}}(".image-popup");function p(e){const s=new t(e,"#cardElement",c.open,v.open,((e,t)=>{e.classList.contains("elements__like-icon_active")?h.deleteLike(t).then((e=>{s.toggelLike(e.likes)})).catch((e=>console.error(`Ошибка при снятии лайка ${e}`))):h.addLike(t).then((e=>{s.toggelLike(e.likes)})).catch((e=>console.error(`Ошибка при добавлении лайка ${e}`)))}));return s.createCard()}function d(e,t,s="Ошибка",i="Сохранение..."){t.setupText(!0,i),e().then((()=>{t.close()})).catch((e=>console.error(`${s} ${e}`))).finally((()=>t.setupText(!1)))}const m=new class{constructor(e,t){this._container=document.querySelector(t),this._renderer=e}addCardFromArray(e){e.forEach((e=>{this._renderer(e)}))}addItemPrepend(e){this._container.prepend(e)}addItemAppend(e){this._container.append(e)}}((e=>{m.addItemAppend(p(e))}),".elements__lists"),E=new r(".profile-popup",e,(e=>{d((function(){return h.setUserInfo(e).then((e=>{_.setUserInfo({name:e.name,job:e.about,avatar:e.avatar})}))}),E,"Ошибка при редактировании профиля")})),b=new r(".card-popup",e,(e=>{d((function(){return Promise.all([h.getInfo(),h.addCard(e)]).then((([e,t])=>{t.myid=e._id,m.addItemPrepend(p(t))}))}),b,"Ошибка при добавлении карточки","Создание...")})),f=new r(".edit-avatar-popup",e,(e=>{d((function(){return h.setNewAvatar(e).then((e=>{_.setUserInfo({name:e.name,job:e.about,avatar:e.avatar})}))}),f,"Ошибка при редактировании аватара")})),v=new class extends i{constructor(e,t,s){super(e),this._load=t,this._submitFunction=s,this._form=this._popup.querySelector(".popup__form"),this._submitButton=this._popup.querySelector(".popup__submit"),this._defaultButtonText=this._submitButton.textContent,this.open=this.open.bind(this)}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._submitFunction({card:this._card,cardId:this._cadrId})}))}setupText(e,t){e?(this._submitButton.textContent="",this._submitButton.style.backgroundImage=`url(${this._load})`):(this._submitButton.style.backgroundImage="none",this._submitButton.textContent=this._defaultButtonText)}open({cardId:e,card:t}){super.open(),this._card=t,this._cadrId=e}}(".delete-popup",e,(({card:e,cardId:t})=>{d((function(){return h.deleteCard(t).then((()=>{e.removeCard(),v.close()}))}),v,"Ошибка при удалении карточки","Удаление...")}));Array.from(document.forms).forEach((e=>{const t=new s(u,e),i=e.getAttribute("name");l[i]=t,t.enableValidation()})),[c,E,b,v,f].forEach((e=>e.setEventListeners())),n.addEventListener("click",(()=>{l.personalData.resetErrorForOpenForm(),E.setInputsValue(_.getUserInfo()),E.open()})),o.addEventListener("click",(()=>{l.addCard.resetErrorForOpenForm(),b.open()})),a.addEventListener("click",(()=>{l.editAvatar.resetErrorForOpenForm(),f.open()})),Promise.all([h.getInfo(),h.getCards()]).then((([e,t])=>{t.forEach((t=>t.myid=e._id)),_.setUserInfo({name:e.name,job:e.about,avatar:e.avatar}),m.addCardFromArray(t)})).catch((e=>console.error(`Ошибка при создании начальных данных страницы ${e}`)))})();